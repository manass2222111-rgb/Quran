<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نور القرآن</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#fdfbf7">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@400;700&display=swap');
        
        * { box-sizing: border-box; }

        body { 
            background-color: #fdfbf7; 
            margin: 0; 
            padding: 0; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* يمنع تحرك الصفحة بالكامل */
            font-family: 'Tajawal', sans-serif;
        }
        
        .font-quran { font-family: 'Amiri', serif; line-height: 2.4; }
        
        /* إخفاء شريط التمرير لكن السماح بالسكرول */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* منطقة القراءة القابلة للسكرول */
        .scrollable-content {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* سكرول ناعم */
            padding-top: 60px; /* مساحة للشريط العلوي الثابت */
            padding-bottom: 40px;
        }

        /* تحسينات الساعة */
        @media (max-width: 450px) {
            .round-watch-safe {
                padding-left: 32px !important;
                padding-right: 32px !important;
            }
            .watch-list-item {
                justify-content: center !important;
                text-align: center !important;
            }
            .hide-on-watch { display: none !important; }
        }

        /* الشريط العلوي الثابت */
        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 55px;
            z-index: 100; /* فوق كل شيء */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* تنسيق الآية */
        .ayah-marker {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 4px; 
            vertical-align: middle;
            height: 0.9em;
            width: 0.9em;
        }
        .ayah-symbol { font-size: 1em; line-height: 1; }
        .ayah-number {
            position: absolute;
            font-size: 0.4em;
            font-family: 'Tajawal', sans-serif;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
        }

        .mushaf-page-content {
            text-align: justify;
            text-align-last: center;
        }

        .surah-frame {
            margin: 20px 0 10px 0;
            padding: 8px;
            border: 1px double currentColor;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            background-color: rgba(0,0,0,0.03);
        }
    </style>
</head>
<body>
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const Icon = ({ d, size=20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d={d} /></svg>
        );

        const toArabicNum = (n) => n.toString().replace(/\d/g, d => "٠١٢٣٤٥٦٧٨٩"[d]);

        function App() {
            const [surahs, setSurahs] = React.useState([]);
            const [pageData, setPageData] = React.useState(null);
            const [currentPageNum, setCurrentPageNum] = React.useState(1);
            const [view, setView] = React.useState('loading'); 
            const [fontSize, setFontSize] = React.useState(() => parseInt(localStorage.getItem('q_fs')) || 22);
            const [darkMode, setDarkMode] = React.useState(() => localStorage.getItem('q_dm') === 'true');
            
            // متغيرات السحب
            const touchStartX = React.useRef(null);
            const touchStartY = React.useRef(null);

            // التحميل الأولي
            React.useEffect(() => {
                const init = async () => {
                    const savedPage = JSON.parse(localStorage.getItem('q_saved_page'));
                    
                    try {
                        const res = await fetch('https://api.alquran.cloud/v1/surah');
                        const data = await res.json();
                        setSurahs(data.data);
                    } catch(e) {}

                    if (savedPage) loadPage(savedPage);
                    else loadPage(1);
                };
                init();
            }, []);

            React.useEffect(() => { localStorage.setItem('q_fs', fontSize); }, [fontSize]);
            React.useEffect(() => { localStorage.setItem('q_dm', darkMode); }, [darkMode]);

            const loadPage = async (pageNum) => {
                if (pageNum < 1 || pageNum > 604) return;
                setView('loading');
                try {
                    const res = await fetch(`https://api.alquran.cloud/v1/page/${pageNum}/quran-uthmani`);
                    const data = await res.json();
                    setPageData(data.data);
                    setCurrentPageNum(pageNum);
                    setView('reader');
                    localStorage.setItem('q_saved_page', JSON.stringify(pageNum));
                    // إعادة السكرول للأعلى
                    setTimeout(() => {
                        const container = document.getElementById('scroll-container');
                        if (container) container.scrollTop = 0;
                    }, 50);
                } catch (e) {
                    setView('list'); 
                }
            };

            const goToSurah = async (surahNumber) => {
                setView('loading');
                try {
                    const res = await fetch(`https://api.alquran.cloud/v1/ayah/${surahNumber}:1`);
                    const data = await res.json();
                    loadPage(data.data.page);
                } catch (e) {
                    loadPage(1);
                }
            };

            // --- منطق السحب المحسن ---
            const onTouchStart = (e) => {
                touchStartX.current = e.touches[0].clientX;
                touchStartY.current = e.touches[0].clientY;
            };

            const onTouchEnd = (e) => {
                if (!touchStartX.current || !touchStartY.current) return;

                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;

                const diffX = touchStartX.current - touchEndX;
                const diffY = touchStartY.current - touchEndY;

                // أهم شرط: يجب أن تكون الحركة أفقية بوضوح (الفرق الأفقي أكبر بكثير من العمودي)
                // هذا يسمح بالسكرول العمودي دون تفعيل قلب الصفحة
                if (Math.abs(diffX) > Math.abs(diffY) + 30) { 
                    if (Math.abs(diffX) > 50) { 
                        if (diffX > 0) loadPage(currentPageNum + 1); // سحب لليسار = التالي
                        else loadPage(currentPageNum - 1); // سحب لليمين = السابق
                    }
                }
                
                touchStartX.current = null;
                touchStartY.current = null;
            };

            const colors = darkMode ? 
                { bg: '#000000', text: '#e0e0e0', headerBg: '#1f2937', border: '#333', accent: '#fbbf24' } : 
                { bg: '#fdfbf7', text: '#000000', headerBg: '#ffffff', border: '#e5e5e5', accent: '#d97706' };

            const headerTitle = view === 'list' ? 'فهرس السور' : (pageData ? pageData.ayahs[0].surah.name : 'نور القرآن');

            if (view === 'loading') return (
                <div style={{background: colors.bg, color: colors.text}} className="h-full w-full flex items-center justify-center text-xl font-bold">...</div>
            );

            return (
                <div style={{background: colors.bg, color: colors.text}} className="h-full w-full relative">
                    
                    {/* --- الشريط العلوي الثابت (Fixed Header) --- */}
                    <button 
                        onClick={() => setView('list')}
                        className="fixed-header active:opacity-60 transition-opacity"
                        style={{backgroundColor: colors.headerBg, borderBottom: `1px solid ${colors.border}`, color: colors.text}} 
                    >
                        <div className="font-bold text-lg truncate px-8 w-full text-center font-quran pointer-events-none">
                            {headerTitle}
                        </div>
                        
                        {/* أيقونات توضيحية */}
                        <div className="absolute left-4 opacity-50 pointer-events-none">
                            {view === 'reader' ? <Icon d="M4 6h16M4 12h16M4 18h16" size={22} /> : 
                             <Icon d="M19 12H5m7 7l-7-7 7-7" size={22} />}
                        </div>
                    </button>

                    {/* --- المحتوى القابل للسكرول --- */}
                    {/* 1. القائمة */}
                    {view === 'list' && (
                        <div className="scrollable-content round-watch-safe">
                            <button 
                                onClick={() => setView('settings')}
                                className="w-full p-4 border-b font-bold flex justify-between items-center bg-gray-100/5 mb-2"
                                style={{borderColor: colors.border, color: colors.text}}
                            >
                                <span className="flex items-center gap-2">
                                    <Icon d="M12 15a3 3 0 100-6 3 3 0 000 6z" size={18} />
                                    الإعدادات
                                </span>
                                <span>›</span>
                            </button>

                            {surahs.map(s => (
                                <button 
                                    key={s.number}
                                    onClick={() => goToSurah(s.number)}
                                    className="w-full p-4 border-b active:bg-black/10 flex items-center text-right watch-list-item"
                                    style={{borderColor: colors.border, color: colors.text}}
                                >
                                    <div className="flex items-center gap-2 pointer-events-none">
                                        <span className="font-bold font-quran text-xl">{toArabicNum(s.number)}.</span>
                                        <span className="font-bold font-quran text-xl">{s.name}</span>
                                    </div>
                                </button>
                            ))}
                        </div>
                    )}

                    {/* 2. القارئ */}
                    {view === 'reader' && pageData && (
                        <div 
                            id="scroll-container"
                            className="scrollable-content round-watch-safe"
                            onTouchStart={onTouchStart}
                            onTouchEnd={onTouchEnd}
                        >
                            <div className="mushaf-page-content font-quran px-1" style={{fontSize: fontSize + 'px'}}>
                                {pageData.ayahs.map((ayah, i) => {
                                    const isSurahStart = ayah.numberInSurah === 1;
                                    const showBismillah = isSurahStart && ayah.surah.number !== 1 && ayah.surah.number !== 9;
                                    let text = ayah.text;
                                    if (showBismillah) text = text.replace("بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ", "").trim();

                                    return (
                                        <span key={i}>
                                            {isSurahStart && (
                                                <div className="surah-frame">سورة {ayah.surah.name}</div>
                                            )}
                                            {showBismillah && (
                                                <div className="text-center w-full mb-2 opacity-80 text-sm">بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ</div>
                                            )}
                                            <span>
                                                {text}
                                                <span className="ayah-marker select-none" style={{color: colors.accent}}>
                                                    <span className="ayah-symbol">&#1757;</span>
                                                    <span className="ayah-number">{toArabicNum(ayah.numberInSurah)}</span>
                                                </span>
                                            </span>
                                        </span>
                                    );
                                })}
                            </div>

                            <div className="text-center text-xs opacity-50 py-4 border-t mt-4 mb-8" style={{borderColor: colors.border}}>
                                صفحة {toArabicNum(currentPageNum)}
                            </div>
                        </div>
                    )}

                    {/* 3. الإعدادات */}
                    {view === 'settings' && (
                        <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-[200]">
                            <div style={{background: colors.bg, borderColor: colors.border}} className="p-4 rounded-2xl w-full max-w-[280px] text-center border">
                                <h3 className="font-bold mb-4">حجم الخط</h3>
                                <div className="flex justify-center gap-3 mb-6">
                                    <button onClick={() => setFontSize(f => Math.max(16, f-2))} className="w-10 h-10 bg-gray-200 text-black rounded-lg font-bold text-xl">-</button>
                                    <span className="text-xl font-quran flex items-center">{toArabicNum(fontSize)}</span>
                                    <button onClick={() => setFontSize(f => Math.min(40, f+2))} className="w-10 h-10 bg-gray-200 text-black rounded-lg font-bold text-xl">+</button>
                                </div>
                                <button onClick={() => setDarkMode(!darkMode)} className="w-full py-3 mb-4 rounded-xl bg-gray-200 text-black font-bold">
                                    {darkMode ? 'الوضع النهاري' : 'الوضع الليلي'}
                                </button>
                                <button onClick={() => setView('list')} className="text-red-500 font-bold p-2 w-full h-10">إغلاق</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
