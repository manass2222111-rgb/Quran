<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نور القرآن</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#fdfbf7">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@400;700&display=swap');
        
        body { 
            background-color: #fdfbf7; 
            margin: 0; 
            padding: 0; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* لمنع سكرول الصفحة الرئيسية */
        }
        
        .font-quran { font-family: 'Amiri', serif; line-height: 2.3; }
        .font-ui { font-family: 'Tajawal', sans-serif; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- تحسينات الساعات الدائرية --- */
        @media (max-width: 450px) {
            .round-watch-safe {
                padding-left: max(14px, env(safe-area-inset-left));
                padding-right: max(14px, env(safe-area-inset-right));
            }
            .watch-list-item {
                justify-content: center !important;
                text-align: center !important;
                padding-right: 0 !important;
            }
            .hide-on-watch { display: none !important; }
        }

        /* تنسيق الآية */
        .ayah-marker {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 4px; 
            vertical-align: middle;
            height: 0.9em;
            width: 0.9em;
        }
        .ayah-symbol { font-size: 1em; line-height: 1; }
        .ayah-number {
            position: absolute;
            font-size: 0.4em;
            font-family: 'Tajawal', sans-serif;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
        }

        /* تنسيق صفحة المصحف */
        .mushaf-page-content {
            text-align: justify; /* ضبط النص كالمصحف */
            text-align-last: center; /* آخر سطر في الوسط */
            padding-bottom: 60px; /* مساحة في الأسفل للسكرول */
        }

        /* إطار بداية السورة */
        .surah-frame {
            margin: 15px 0 10px 0;
            padding: 8px;
            border: 1px double currentColor;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            background-color: rgba(0,0,0,0.03);
        }
    </style>
</head>
<body>
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const Icon = ({ d, size=20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d={d} /></svg>
        );

        const toArabicNum = (n) => n.toString().replace(/\d/g, d => "٠١٢٣٤٥٦٧٨٩"[d]);

        function App() {
            // البيانات
            const [surahs, setSurahs] = React.useState([]);
            const [pageData, setPageData] = React.useState(null); // بيانات الصفحة الحالية (وليس السورة)
            const [currentPageNum, setCurrentPageNum] = React.useState(1);
            
            const [view, setView] = React.useState('loading'); 
            const [fontSize, setFontSize] = React.useState(() => parseInt(localStorage.getItem('q_fs')) || 22);
            const [darkMode, setDarkMode] = React.useState(() => localStorage.getItem('q_dm') === 'true');
            
            // متغيرات السحب (Swipe)
            const touchStartRef = React.useRef(null);
            const minSwipeDistance = 50; 

            // --- التحميل الأولي ---
            React.useEffect(() => {
                const init = async () => {
                    const savedPage = JSON.parse(localStorage.getItem('q_saved_page'));
                    
                    // تحميل القائمة
                    try {
                        const res = await fetch('https://api.alquran.cloud/v1/surah');
                        const data = await res.json();
                        setSurahs(data.data);
                    } catch(e) {}

                    // فتح آخر صفحة محفوظة أو الصفحة 1
                    if (savedPage) {
                        loadPage(savedPage);
                    } else {
                        loadPage(1); 
                    }
                };
                init();
            }, []);

            React.useEffect(() => { localStorage.setItem('q_fs', fontSize); }, [fontSize]);
            React.useEffect(() => { localStorage.setItem('q_dm', darkMode); }, [darkMode]);

            // --- دالة تحميل صفحة مصحف (1-604) ---
            const loadPage = async (pageNum) => {
                if (pageNum < 1 || pageNum > 604) return;
                
                setView('loading');
                try {
                    const res = await fetch(`https://api.alquran.cloud/v1/page/${pageNum}/quran-uthmani`);
                    const data = await res.json();
                    setPageData(data.data);
                    setCurrentPageNum(pageNum);
                    setView('reader');
                    localStorage.setItem('q_saved_page', JSON.stringify(pageNum));
                    
                    // إعادة السكرول للأعلى عند قلب الصفحة
                    const container = document.getElementById('page-container');
                    if (container) container.scrollTop = 0;
                    
                } catch (e) {
                    setView('list'); 
                }
            };

            // --- دالة الانتقال لسورة (نبحث عن رقم صفحتها) ---
            const goToSurah = async (surahNumber) => {
                setView('loading');
                try {
                    // نطلب الآية الأولى من السورة لنعرف في أي صفحة تقع
                    const res = await fetch(`https://api.alquran.cloud/v1/ayah/${surahNumber}:1`);
                    const data = await res.json();
                    loadPage(data.data.page); // نفتح الصفحة التي وجدت فيها السورة
                } catch (e) {
                    loadPage(1);
                }
            };

            // --- معالجة السحب (Swipe Logic) ---
            const onTouchStart = (e) => {
                touchStartRef.current = e.targetTouches[0].clientX;
            }

            const onTouchEnd = (e) => {
                if (!touchStartRef.current) return;
                const touchEnd = e.changedTouches[0].clientX;
                const distance = touchStartRef.current - touchEnd;
                const isLeftSwipe = distance > minSwipeDistance;
                const isRightSwipe = distance < -minSwipeDistance;

                if (isLeftSwipe) {
                    // سحب لليسار = الصفحة التالية
                    loadPage(currentPageNum + 1);
                }
                if (isRightSwipe) {
                    // سحب لليمين = الصفحة السابقة
                    loadPage(currentPageNum - 1);
                }
            }

            const colors = darkMode ? 
                { bg: '#000000', text: '#e0e0e0', headerBg: '#111', border: '#333', accent: '#fbbf24', secondary: '#1f2937' } : 
                { bg: '#fdfbf7', text: '#000000', headerBg: '#fff', border: '#e5e5e5', accent: '#d97706', secondary: '#f3f4f6' };

            // استخراج اسم السورة الظاهرة في الصفحة الحالية للعنوان
            const headerTitle = view === 'list' ? 'فهرس السور' : (pageData ? pageData.ayahs[0].surah.name : 'نور القرآن');

            if (view === 'loading') return (
                <div style={{background: colors.bg, color: colors.text}} className="h-full w-full flex items-center justify-center font-ui text-xl font-bold">
                    ...
                </div>
            );

            return (
                <div style={{background: colors.bg, color: colors.text}} className="h-full w-full flex flex-col font-ui overflow-hidden">
                    
                    {/* --- الشريط العلوي (زر القائمة) --- */}
                    <button 
                        onClick={() => setView('list')}
                        style={{backgroundColor: colors.headerBg, borderBottom: `1px solid ${colors.border}`}} 
                        className="flex items-center justify-center p-2 shrink-0 h-12 w-full relative z-50 active:opacity-60 transition-opacity"
                    >
                        <div className="font-bold text-lg truncate px-2 text-center w-full font-quran">
                            {headerTitle}
                        </div>
                        {view === 'reader' && (
                            <div className="absolute left-4 opacity-50">
                                <Icon d="M4 6h16M4 12h16M4 18h16" size={20} />
                            </div>
                        )}
                        {view === 'list' && (
                            <div className="absolute left-4 opacity-50 transform rotate-180">
                                <Icon d="M19 12H5m7 7l-7-7 7-7" size={20} />
                            </div>
                        )}
                    </button>

                    {/* --- المحتوى --- */}
                    <div className="flex-1 w-full relative overflow-hidden">
                        
                        {/* 1. القائمة */}
                        {view === 'list' && (
                            <div className="h-full overflow-y-auto no-scrollbar pb-10 w-full">
                                <button 
                                    onClick={() => setView('settings')}
                                    className="w-full p-3 border-b font-bold flex justify-between items-center round-watch-safe bg-gray-100/5"
                                    style={{borderColor: colors.border, color: colors.text}}
                                >
                                    <span className="flex items-center gap-2">
                                        <Icon d="M12 15a3 3 0 100-6 3 3 0 000 6z" size={18} />
                                        الإعدادات
                                    </span>
                                    <span>›</span>
                                </button>

                                {surahs.map(s => (
                                    <button 
                                        key={s.number}
                                        onClick={() => goToSurah(s.number)}
                                        className="w-full p-3 border-b active:bg-black/10 flex items-center text-right round-watch-safe watch-list-item"
                                        style={{borderColor: colors.border, color: colors.text}}
                                    >
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold font-quran text-xl">{toArabicNum(s.number)}.</span>
                                            <span className="font-bold font-quran text-xl">{s.name}</span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        )}

                        {/* 2. القارئ (نظام الصفحات) */}
                        {view === 'reader' && pageData && (
                            <div 
                                id="page-container"
                                className="h-full w-full overflow-y-auto no-scrollbar"
                                onTouchStart={onTouchStart}
                                onTouchEnd={onTouchEnd}
                            >
                                <div className="px-3 pt-2 round-watch-safe">
                                    <div className="mushaf-page-content font-quran" style={{fontSize: fontSize + 'px'}}>
                                        
                                        {pageData.ayahs.map((ayah, i) => {
                                            const isSurahStart = ayah.numberInSurah === 1;
                                            const showBismillah = isSurahStart && ayah.surah.number !== 1 && ayah.surah.number !== 9;
                                            let text = ayah.text;
                                            if (showBismillah) text = text.replace("بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ", "").trim();

                                            return (
                                                <span key={i}>
                                                    {/* رأس السورة إذا كانت بداية سورة */}
                                                    {isSurahStart && (
                                                        <div className="surah-frame">
                                                            سورة {ayah.surah.name}
                                                        </div>
                                                    )}
                                                    
                                                    {/* البسملة */}
                                                    {showBismillah && (
                                                        <div className="text-center w-full mb-2 opacity-80 text-sm">
                                                            بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ
                                                        </div>
                                                    )}

                                                    {/* الآية */}
                                                    <span>
                                                        {text}
                                                        <span className="ayah-marker select-none" style={{color: colors.accent}}>
                                                            <span className="ayah-symbol">&#1757;</span>
                                                            <span className="ayah-number">{toArabicNum(ayah.numberInSurah)}</span>
                                                        </span>
                                                    </span>
                                                </span>
                                            );
                                        })}
                                    </div>

                                    {/* رقم الصفحة في الأسفل */}
                                    <div className="text-center text-xs opacity-50 py-4 font-ui border-t mt-4" style={{borderColor: colors.border}}>
                                        صفحة {toArabicNum(currentPageNum)}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 3. الإعدادات */}
                        {view === 'settings' && (
                            <div className="h-full w-full flex items-center justify-center p-4 bg-black/90 absolute inset-0 z-50">
                                <div style={{background: colors.bg, borderColor: colors.border}} className="p-4 rounded-2xl w-full max-w-[280px] text-center border">
                                    <h3 className="font-bold mb-4 font-ui">حجم الخط</h3>
                                    <div className="flex justify-center gap-3 mb-6">
                                        <button onClick={() => setFontSize(f => Math.max(16, f-2))} className="w-10 h-10 bg-gray-200 text-black rounded-lg font-bold text-xl">-</button>
                                        <span className="text-xl font-quran flex items-center">{toArabicNum(fontSize)}</span>
                                        <button onClick={() => setFontSize(f => Math.min(40, f+2))} className="w-10 h-10 bg-gray-200 text-black rounded-lg font-bold text-xl">+</button>
                                    </div>
                                    <button onClick={() => setDarkMode(!darkMode)} className="w-full py-3 mb-4 rounded-xl bg-gray-200 text-black font-bold font-ui">
                                        {darkMode ? 'الوضع النهاري' : 'الوضع الليلي'}
                                    </button>
                                    <button onClick={() => setView('list')} className="text-red-500 font-bold p-2">إغلاق</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

