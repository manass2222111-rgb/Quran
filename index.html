<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نور القرآن</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#fdfbf7">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@400;700&display=swap');
        
        body { 
            background-color: #fdfbf7; 
            margin: 0; 
            padding: 0; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none; /* منع ارتداد المتصفح */
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        
        .font-quran { font-family: 'Amiri', serif; line-height: 2.2; }
        .font-ui { font-family: 'Tajawal', sans-serif; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- تحسينات الساعات الدائرية --- */
        @media (max-width: 450px) {
            .round-watch-safe {
                padding-left: max(14px, env(safe-area-inset-left));
                padding-right: max(14px, env(safe-area-inset-right));
            }
            .watch-list-item {
                justify-content: center !important;
                text-align: center !important;
                padding-right: 0 !important;
            }
            .hide-on-watch { display: none !important; }
        }

        /* تنسيق الآية */
        .ayah-marker {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 4px; 
            vertical-align: middle;
            height: 0.9em;
            width: 0.9em;
        }
        .ayah-symbol { font-size: 1em; line-height: 1; }
        .ayah-number {
            position: absolute;
            font-size: 0.4em;
            font-family: 'Tajawal', sans-serif;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
        }

        /* تنسيق صفحة المصحف */
        .mushaf-page {
            text-align: justify;
            text-align-last: center; /* السطر الأخير في الصفحة يكون في الوسط */
            padding: 0 10px;
        }

        /* رأس السورة داخل الصفحة */
        .surah-header-frame {
            border: 1px solid currentColor;
            border-radius: 8px;
            margin: 10px 0;
            padding: 5px;
            text-align: center;
            background: rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const Icon = ({ d, size=20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d={d} /></svg>
        );

        const toArabicNum = (n) => n.toString().replace(/\d/g, d => "٠١٢٣٤٥٦٧٨٩"[d]);

        function App() {
            // State
            const [surahs, setSurahs] = React.useState([]);
            const [currentPageData, setCurrentPageData] = React.useState(null);
            const [currentPageNum, setCurrentPageNum] = React.useState(1);
            const [view, setView] = React.useState('loading'); 
            const [fontSize, setFontSize] = React.useState(() => parseInt(localStorage.getItem('q_fs')) || 22);
            const [darkMode, setDarkMode] = React.useState(() => localStorage.getItem('q_dm') === 'true');
            
            // Touch Handling for Swipe
            const [touchStart, setTouchStart] = React.useState(null);
            const [touchEnd, setTouchEnd] = React.useState(null);

            const minSwipeDistance = 50;
            const isWatch = window.innerWidth <= 450;

            // --- التحميل الأولي ---
            React.useEffect(() => {
                const init = async () => {
                    const saved = JSON.parse(localStorage.getItem('q_save_page'));
                    
                    // جلب قائمة السور (لمعرفة بداية كل سورة في أي صفحة)
                    try {
                        const res = await fetch('https://api.alquran.cloud/v1/surah');
                        const data = await res.json();
                        setSurahs(data.data);
                    } catch(e) {}

                    if (saved) {
                        loadPage(saved.page);
                    } else {
                        loadPage(1); // الفاتحة (صفحة 1)
                    }
                };
                init();
            }, []);

            // حفظ الإعدادات
            React.useEffect(() => { localStorage.setItem('q_fs', fontSize); }, [fontSize]);
            React.useEffect(() => { localStorage.setItem('q_dm', darkMode); }, [darkMode]);

            // --- تحميل الصفحة (بيانات صفحة كاملة) ---
            const loadPage = async (pageNum) => {
                if (pageNum < 1 || pageNum > 604) return;
                
                setView('loading');
                try {
                    const res = await fetch(`https://api.alquran.cloud/v1/page/${pageNum}/quran-uthmani`);
                    const data = await res.json();
                    setCurrentPageData(data.data);
                    setCurrentPageNum(pageNum);
                    setView('reader');
                    
                    // حفظ رقم الصفحة
                    localStorage.setItem('q_save_page', JSON.stringify({ page: pageNum }));
                } catch (e) {
                    // في حال الفشل
                    setView('list'); 
                }
            };

            // --- منطق السحب (Swipe) ---
            const onTouchStart = (e) => {
                setTouchEnd(null); 
                setTouchStart(e.targetTouches[0].clientX);
            }

            const onTouchMove = (e) => {
                setTouchEnd(e.targetTouches[0].clientX);
            }

            const onTouchEnd = () => {
                if (!touchStart || !touchEnd) return;
                const distance = touchStart - touchEnd;
                const isLeftSwipe = distance > minSwipeDistance;
                const isRightSwipe = distance < -minSwipeDistance;

                if (isLeftSwipe) {
                    // سحب لليسار = الصفحة التالية (نحن عربية)
                    // في الكتب العربية: الصفحة التالية تعني قلب الورقة لليمين، لكن في اللمس:
                    // سحب لليسار (Next) | سحب لليمين (Prev)
                    // لكن بما ان الاتجاه RTL:
                    loadPage(currentPageNum + 1);
                }
                if (isRightSwipe) {
                    // سحب لليمين = الصفحة السابقة
                    loadPage(currentPageNum - 1);
                }
            }

            // --- الانتقال لسورة معينة (تحويل السورة لرقم صفحة) ---
            const goToSurah = (surahObj) => {
                // للأسف الAPI في قائمة السور لا يعطي رقم الصفحة مباشرة في كل الأحوال
                // لكن معظم البيانات تتضمن ذلك. سنفترض أننا نملك خرائط أو نعتمد على التحميل
                // الحل الأبسط: الانتقال لأول آية في السورة، الAPI سيجلب الصفحة.
                // لكن هنا سنستخدم ميزة في api alquran cloud: الانتقال لصفحة السورة
                // نحتاج معرفة رقم صفحة السورة. القائمة المحملة تحتوي "page" غالباً
                // إذا لم توجد، سنستخدم منطق تقريبي أو نطلب الآية 1.
                // لتسهيل الأمر في هذا التطبيق الخفيف: سننتقل للصفحة التي تبدأ فيها السورة.
                // (بيانات surahs API تحتوي على رقم الصفحة)
                // *ملاحظة: نسخة alquran.cloud العادية لا ترجع رقم الصفحة في قائمة السور المبسطة*
                // لذلك سنقوم بحيلة: تحميل السورة كاملة لمعرفة صفحتها؟ لا، ثقيل.
                // الحل: البحث عن رقم الصفحة يدوياً أو الاعتماد على أن المستخدم يتصفح.
                // *تصحيح*: سنعتمد على المستخدم يقلب، أو نستخدم مصفوفة بسيطة لبدايات الصفحات إذا لزم الأمر.
                // ولكن للتبسيط: عند الضغط على سورة، سنحمل الآية 1 من السورة، ونعرف منها رقم الصفحة.
                
                setView('loading');
                fetch(`https://api.alquran.cloud/v1/ayah/${surahObj.number}:1`)
                    .then(r => r.json())
                    .then(d => {
                        loadPage(d.data.page);
                    })
                    .catch(() => loadPage(1));
            };

            const colors = darkMode ? 
                { bg: '#000000', text: '#e0e0e0', headerBg: '#111', border: '#333', accent: '#fbbf24', secondary: '#1f2937' } : 
                { bg: '#fdfbf7', text: '#000000', headerBg: '#fff', border: '#e5e5e5', accent: '#d97706', secondary: '#f3f4f6' };

            // استخراج اسم السورة الحالية من بيانات الصفحة
            // الصفحة قد تحتوي آيات من سور متعددة، نأخذ اسم السورة من أول آية
            const currentSurahName = currentPageData ? currentPageData.ayahs[0].surah.name : 'نور القرآن';

            if (view === 'loading') return (
                <div style={{background: colors.bg, color: colors.text}} className="h-full w-full flex items-center justify-center font-ui text-xl font-bold">
                    ...
                </div>
            );

            return (
                <div style={{background: colors.bg, color: colors.text}} className="h-full w-full flex flex-col font-ui overflow-hidden">
                    
                    {/* --- الشريط العلوي (زر القائمة) --- */}
                    <button 
                        onClick={() => setView('list')}
                        style={{backgroundColor: colors.headerBg, borderBottom: `1px solid ${colors.border}`}} 
                        className="flex items-center justify-center p-2 shrink-0 h-12 w-full relative z-50 active:opacity-60 transition-opacity"
                    >
                        <div className="font-bold text-lg truncate px-2 text-center w-full font-quran">
                            {view === 'list' ? 'فهرس السور' : currentSurahName}
                        </div>
                        {view === 'reader' && (
                            <div className="absolute left-4 opacity-50">
                                <Icon d="M4 6h16M4 12h16M4 18h16" size={20} />
                            </div>
                        )}
                        {view === 'list' && (
                            <div className="absolute left-4 opacity-50 transform rotate-180">
                                <Icon d="M19 12H5m7 7l-7-7 7-7" size={20} />
                            </div>
                        )}
                    </button>

                    {/* --- المحتوى --- */}
                    <div className="flex-1 w-full relative overflow-hidden">
                        
                        {/* 1. صفحة القائمة */}
                        {view === 'list' && (
                            <div className="h-full overflow-y-auto no-scrollbar pb-10 w-full">
                                {/* زر الإعدادات */}
                                <button 
                                    onClick={() => setView('settings')}
                                    className="w-full p-3 border-b font-bold flex justify-between items-center round-watch-safe bg-gray-100/5"
                                    style={{borderColor: colors.border, color: colors.text}}
                                >
                                    <span className="flex items-center gap-2">
                                        <Icon d="M12 15a3 3 0 100-6 3 3 0 000 6z" size={18} />
                                        الإعدادات
                                    </span>
                                    <span>›</span>
                                </button>

                                {surahs.map(s => (
                                    <button 
                                        key={s.number}
                                        onClick={() => goToSurah(s)}
                                        className="w-full p-3 border-b active:bg-black/10 flex items-center text-right round-watch-safe watch-list-item"
                                        style={{borderColor: colors.border, color: colors.text}}
                                    >
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold font-quran text-xl">{toArabicNum(s.number)}.</span>
                                            <span className="font-bold font-quran text-xl">{s.name}</span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        )}

                        {/* 2. صفحة القراءة (Mushaf Page View) */}
                        {view === 'reader' && currentPageData && (
                            <div 
                                className="h-full w-full flex flex-col relative"
                                onTouchStart={onTouchStart}
                                onTouchMove={onTouchMove}
                                onTouchEnd={onTouchEnd}
                            >
                                {/* محتوى الصفحة */}
                                <div className="flex-1 overflow-y-auto no-scrollbar flex items-center justify-center p-1">
                                    <div className="w-full h-full flex flex-col justify-center round-watch-safe">
                                        
                                        <div className="mushaf-page font-quran" style={{fontSize: fontSize + 'px'}}>
                                            {currentPageData.ayahs.map((ayah, i) => {
                                                // التحقق مما إذا كانت هذه الآية بداية سورة (رقم 1)
                                                const isStartOfSurah = ayah.numberInSurah === 1;
                                                const showBismillah = isStartOfSurah && ayah.surah.number !== 1 && ayah.surah.number !== 9;
                                                let text = ayah.text;
                                                if (showBismillah) text = text.replace("بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ", "").trim();

                                                return (
                                                    <span key={i}>
                                                        {/* رأس السورة */}
                                                        {isStartOfSurah && (
                                                            <div className="surah-header-frame mt-4 mb-2">
                                                                سورة {ayah.surah.name}
                                                            </div>
                                                        )}
                                                        
                                                        {/* البسملة */}
                                                        {showBismillah && (
                                                            <div className="text-center w-full mb-2 opacity-80 text-sm">
                                                                بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ
                                                            </div>
                                                        )}

                                                        {/* نص الآية */}
                                                        <span>
                                                            {text}
                                                            <span className="ayah-marker select-none" style={{color: colors.accent}}>
                                                                <span className="ayah-symbol">&#1757;</span>
                                                                <span className="ayah-number">{toArabicNum(ayah.numberInSurah)}</span>
                                                            </span>
                                                        </span>
                                                    </span>
                                                )
                                            })}
                                        </div>
                                    </div>
                                </div>

                                {/* ذيل الصفحة (رقم الصفحة) */}
                                <div className="h-8 shrink-0 flex justify-center items-center text-xs opacity-50 font-ui border-t" style={{borderColor: colors.border}}>
                                    صفحة {toArabicNum(currentPageNum)}
                                </div>
                            </div>
                        )}

                        {/* 3. الإعدادات */}
                        {view === 'settings' && (
                            <div className="h-full w-full flex items-center justify-center p-4 bg-black/90 absolute inset-0 z-50">
                                <div style={{background: colors.bg, borderColor: colors.border}} className="p-4 rounded-2xl w-full max-w-[280px] text-center border">
                                    <h3 className="font-bold mb-4 font-ui">حجم الخط</h3>
                                    <div className="flex justify-center gap-3 mb-6">
                                        <button onClick={() => setFontSize(f => Math.max(16, f-2))} className="w-10 h-10 bg-gray-200 text-black rounded-lg font-bold text-xl">-</button>
                                        <span className="text-xl font-quran flex items-center">{toArabicNum(fontSize)}</span>
                                        <button onClick={() => setFontSize(f => Math.min(40, f+2))} className="w-10 h-10 bg-gray-200 text-black rounded-lg font-bold text-xl">+</button>
                                    </div>
                                    <button onClick={() => setDarkMode(!darkMode)} className="w-full py-3 mb-4 rounded-xl bg-gray-200 text-black font-bold font-ui">
                                        {darkMode ? 'الوضع النهاري' : 'الوضع الليلي'}
                                    </button>
                                    <button onClick={() => setView('list')} className="text-red-500 font-bold p-2">إغلاق</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

